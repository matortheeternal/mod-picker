/*! plupload-angular-directive 22-02-2015 */
"use strict";angular.module("plupload.directive",[]).provider("plUploadService",function(){var a={flashPath:"bower_components/plupload-angular-directive/dist/plupload.flash.swf",silverLightPath:"bower_components/plupload-angular-directive/dist/plupload.silverlight.xap",uploadPath:"upload.php"};this.setConfig=function(b,c){a[b]=c},this.getConfig=function(b){return a[b]};var b=this;this.$get=[function(){return{getConfig:b.getConfig,setConfig:b.setConfig}}]}).directive("plUpload",["$parse","plUploadService",function(a,b){return{restrict:"A",scope:{plProgressModel:"=",plFilesModel:"=",plFiltersModel:"=",plMultiParamsModel:"=",plInstance:"="},link:function(c,d,e){if(c.randomString=function(a,b){b=b||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var c="",d=0;a>d;d++){var e=Math.floor(Math.random()*b.length);c+=b.substring(e,e+1)}return c},!e.id){var f=c.randomString(5);e.$set("id",f)}e.plAutoUpload||e.$set("plAutoUpload","true"),e.plMaxFileSize||e.$set("plMaxFileSize","10mb"),e.plUrl||e.$set("plUrl",b.getConfig("uploadPath")),e.plFlashSwfUrl||e.$set("plFlashSwfUrl",b.getConfig("flashPath")),e.plSilverlightXapUrl||e.$set("plSilverlightXapUrl",b.getConfig("silverLightPath")),c.filters="undefined"==typeof c.plFiltersModel?[{title:"Image files",extensions:"jpg,jpeg,gif,png,tiff,pdf"}]:c.plFiltersModel;var g={runtimes:"html5,flash,silverlight",browse_button:e.id,multi_selection:!0,max_file_size:e.plMaxFileSize,url:e.plUrl,flash_swf_url:e.plFlashSwfUrl,silverlight_xap_url:e.plSilverlightXapUrl,filters:c.filters};c.plMultiParamsModel&&(g.multipart_params=c.plMultiParamsModel);var h=new plupload.Uploader(g);h.settings.headers=b.getConfig("headers"),h.init(),h.bind("Error",function(a,b){e.onFileError&&c.$parent.$apply(onFileError),alert("Cannot upload, error: "+b.message+(b.file?", File: "+b.file.name:"")),a.refresh()}),h.bind("FilesAdded",function(a,b){c.$apply(function(){e.plFilesModel&&angular.forEach(b,function(a){c.plFilesModel.push(a)}),e.onFileAdded&&c.$parent.$eval(e.onFileAdded)}),"true"==e.plAutoUpload&&h.start()}),h.bind("FileUploaded",function(b,d,f){if(e.onFileUploaded)if(e.plFilesModel)c.$apply(function(){if(angular.forEach(c.plFilesModel,function(a){c.allUploaded=!1,100==a.percent&&(c.allUploaded=!0)}),c.allUploaded){var b=a(e.onFileUploaded);b(c.$parent,{$response:f})}});else{var g=a(e.onFileUploaded);c.$apply(function(){g(c.$parent,{$response:f})})}}),h.bind("UploadProgress",function(a,b){e.plProgressModel&&(c.$apply(e.plFilesModel?function(){c.sum=0,angular.forEach(c.plFilesModel,function(a){c.sum=c.sum+a.percent}),c.plProgressModel=c.sum/c.plFilesModel.length}:function(){c.plProgressModel=b.percent}),e.onFileProgress&&c.$parent.$eval(e.onFileProgress))}),e.plInstance&&(c.plInstance=h)}}}]);